<html xmlns="http://www.w3.org/1999/xhtml" xmlns:wicket="http://wicket.apache.org/dtds.data/wicket-xhtml1.4-strict.dtd">

<wicket:head>
    <meta charset='utf-8'/>
    <script src="https://code.jquery.com/jquery-3.6.0.js" type="text/javascript"></script>
    <script src='/hterm/hterm_all.js'></script>
    <style>
        #terminal {
            display: block;
            position: relative;
            height: 80%;
            width: 98%;
            margin: 0px;
            padding: 0px;
            margin-left: 20px;
        }
    </style>
</wicket:head>


<wicket:extend>
    <body>
        <div class="container-fluid" id="page">
            <ul class="inline">
                <li>
                    <h4 class="muted">Hosts:</h4>
                </li>
                <li>
                    <form wicket:id="hostChoice-form">
                        <select wicket:id="choices-host" id="selected-host" onchange="logParameterChanged()"></select>
                    </form>
                </li>

                <li>
                    <h4 class="muted">Programs:</h4>
                </li>
                <li>
                    <form wicket:id="programChoice-form">
                        <select wicket:id="choices-program" id="selected-program" onchange="logParameterChanged()"></select>
                    </form>
                </li>
            </ul>
        </div>

        <div id='terminal'></div>

        <script>

            var isLogPollEnabled = false;
            var term;
            var terminalIO;

            function initContent() {
               setInterval(function() { getLatestLogs()} , 1000);
                //var i = 0;
                //setInterval(function() {
                //    terminalIO.println(i++  + " " + new Date());
                //}, 250);
            }

            function logParameterChanged() {
                isLogPollEnabled = false;
                //terminalIO.terminal_.clear();
                setupHterm();
                isLogPollEnabled = true;
            }

            function getLatestLogs () {
                if (isLogPollEnabled) {
                    var url = "http://localhost:8080/term-log";

                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", url);

                    xhr.setRequestHeader("Accept", "application/json");
                    xhr.setRequestHeader("Content-Type", "application/json");

                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4) {
                            console.log(xhr.status);
                            console.log(xhr.responseText);

                            var logObj = JSON.parse(xhr.responseText);

                            for (i = logObj.length - 1; i >= 0; i--) {
                                var log = logObj[i];
                                var logDate = new Date(log.date);
                                terminalIO.println(logDate.toLocaleString() + ' ' + logDate.getMilliseconds() + 'ms' + ' [' + log.host + '] [' + log.program + '] ' + log.message);
                            }
                        }};

                    var logRequest = {
                        hostName: $("#selected-host option:selected").text(),
                        programName: $("#selected-program option:selected").text()
                    }

                    xhr.send(JSON.stringify(logRequest));
                }
            }

            // Load translations if available.
            lib.registerInit('load messages', async () => {
                // Try to load the messages database from nassh.  This isn't strictly needed
                // (so if it fails, it should be fine), but does help when testing locally.
                // $1 here means we search the user's language.  Change it to 'en' or another
                // specific language to test those specifically.
                const lang = '$1';
                await hterm.messageManager.findAndLoadMessages(
                    lib.f.getURL(`../../nassh/_locales/${lang}/messages.json`));
            });

            function setupHterm() {

                term = new hterm.Terminal();

                term.onTerminalReady = function() {
                    terminalIO = this.io.push();
                    function printPrompt() {
                        terminalIO.print(
                            '\x1b[38:2:51:105:232mh' +
                            '\x1b[38:2:213:15:37mt' +
                            '\x1b[38:2:238:178:17me' +
                            '\x1b[38:2:51:105:232mr' +
                            '\x1b[38:2:0:153:37mm' +
                            '\x1b[38:2:213:15:37m>' +
                            '\x1b[0m ');
                    }

                    terminalIO.onVTKeystroke = (string) => {
                        switch (string) {
                            case '\r':
                                terminalIO.println('');
                                printPrompt();
                                break;
                            case '\x7f':
                                // \x08 = backspace, \x1b[K = 'Erase in line'.
                                terminalIO.print('\x08\x1b[K');
                                break;
                            default:
                                terminalIO.print(string);
                                break;
                        }
                    };
                    terminalIO.sendString = terminalIO.print;
                    isLogPollEnabled = true;
                    //printPrompt();
                    this.setCursorVisible(true);

                    this.keyboard.bindings.addBinding('F11', 'PASS');
                    this.keyboard.bindings.addBinding('Ctrl+R', 'PASS');
                };
                term.decorate(document.querySelector('#terminal'));
                // term.installKeyboard();

                term.contextMenu.setItems([
                    {name: 'Terminal Reset', action: () => term.reset()},
                    {name: 'Terminal Clear', action: () => term.clear()},
                    {name: hterm.ContextMenu.SEPARATOR},
                    {name: 'Homepage', action: function() {
                            lib.f.openWindow(
                                'https://chromium.googlesource.com/apps/libapps/+/HEAD/hterm/README.md',
                                '_blank');
                        }},
                    {name: 'FAQ', action: function() {
                            lib.f.openWindow('https://goo.gl/muppJj', '_blank');
                        }},
                ]);

                // Useful for console debugging.
                window.term_ = term;
            }

            window.onload = async function() {
                await lib.init();
                setupHterm();
                initContent();
            };
        </script>
    </body>
</wicket:extend>

</html>